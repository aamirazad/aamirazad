name: Merge Bot

on:
  issue_comment:
    types: [created]

jobs:
  merge-and-update:
    if: github.event.issue.pull_request != null && contains(github.event.comment.body, '/merge')
    runs-on: ubuntu-latest
    steps:
      - name: Create loading comment
        id: loading_comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          COMMENT_ID=$(gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments" \
            -f body='<img src="https://xrgkyc5aexvkc7oh.public.blob.vercel-storage.com/loading-spinner-TPIqYiHmChtY21ZfF6puFEZq9X5MDx" width="20" align="top">  Merging...

          _I&apos;m going as fast as I can!_

          [View workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})' \
            --jq '.id')
          echo "comment_id=$COMMENT_ID" >> $GITHUB_OUTPUT

      - name: Set commenter info
        run: |
          set -euo pipefail
          echo "COMMENTER=${{ github.event.comment.user.login }}" >> $GITHUB_ENV
          echo "PR_NUMBER=${{ github.event.issue.number }}" >> $GITHUB_ENV

      - name: Check permissions
        id: permission_check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          PERMISSION=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/collaborators/${{ env.COMMENTER }}/permission" \
            --jq '.permission')

          if [[ "$PERMISSION" == "admin" || "$PERMISSION" == "write" ]]; then
            echo "allowed=true" >> $GITHUB_OUTPUT
          else
            echo "allowed=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment permission denied
        if: failure() || steps.permission_check.outputs.allowed == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          gh api \
            --method PATCH \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/issues/comments/${{ steps.loading_comment.outputs.comment_id }}" \
            -f body='üîí Sorry @${{ env.COMMENTER }}, only repository maintainers can use the `/merge` command.

          [View workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})'
          # Ensure the job stops after notifying permission denied
          exit 1

      - name: Checkout repo
        if: steps.permission_check.outputs.allowed == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get PR details
        if: steps.permission_check.outputs.allowed == 'true'
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          PR_DATA=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/pulls/${{ github.event.issue.number }}")

          echo "branch=$(echo "$PR_DATA" | jq -r '.head.ref')" >> $GITHUB_OUTPUT
          echo "base_branch=$(echo "$PR_DATA" | jq -r '.base.ref')" >> $GITHUB_OUTPUT
          echo "title=$(echo "$PR_DATA" | jq -r '.title')" >> $GITHUB_OUTPUT
          echo "author=$(echo "$PR_DATA" | jq -r '.user.login')" >> $GITHUB_OUTPUT
          echo "mergeable=$(echo "$PR_DATA" | jq -r '.mergeable')" >> $GITHUB_OUTPUT
          echo "state=$(echo "$PR_DATA" | jq -r '.state')" >> $GITHUB_OUTPUT
          # Use optional operator to avoid errors when there are no labels
          echo "labels=$(echo "$PR_DATA" | jq -c '[.labels[]?.name]')" >> $GITHUB_OUTPUT

      - name: Fetch all branches
        if: steps.permission_check.outputs.allowed == 'true'
        run: git fetch origin +refs/heads/*:refs/remotes/origin/*

      - name: Check if changelog should be skipped
        if: steps.permission_check.outputs.allowed == 'true'
        id: check_changelog
        run: |
          set -euo pipefail
          LABELS='${{ steps.pr.outputs.labels }}'
          BASE_BRANCH='${{ steps.pr.outputs.base_branch }}'
          SKIP="false"
          # If labels JSON can't be parsed or index not found, treat as not present
          if echo "$LABELS" | jq -e 'index("skip-changelog")' > /dev/null 2>&1; then
            SKIP="true"
          fi
          if [ "$BASE_BRANCH" != "main" ]; then
            SKIP="true"
          fi
          echo "skip=$SKIP" >> $GITHUB_OUTPUT

      - name: Check if PR is up to date
        if: steps.permission_check.outputs.allowed == 'true'
        id: up_to_date
        run: |
          set -euo pipefail
          # Fetch the latest state
          git fetch origin ${{ steps.pr.outputs.branch }}
          git fetch origin ${{ steps.pr.outputs.base_branch }}
          
          if git merge-base --is-ancestor origin/${{ steps.pr.outputs.base_branch }} origin/${{ steps.pr.outputs.branch }}; then
            echo "result=up_to_date" >> $GITHUB_OUTPUT
          else
            echo "result=outdated" >> $GITHUB_OUTPUT
          fi

      - name: Comment if outdated
        if: steps.permission_check.outputs.allowed == 'true' && steps.up_to_date.outputs.result == 'outdated'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          gh api \
            --method PATCH \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/issues/comments/${{ steps.loading_comment.outputs.comment_id }}" \
            -f body='‚ö†Ô∏è Cannot fast-forward merge because `${{ steps.pr.outputs.branch }}` is not up to date with `${{ steps.pr.outputs.base_branch }}`. Please rebase your feature branch to `${{ steps.pr.outputs.base_branch }}` and try again.

          [View workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})'
          # Stop the job after notifying outdated branch
          exit 1

      - name: Set additional environment variables for changelog
        if: steps.permission_check.outputs.allowed == 'true' && steps.check_changelog.outputs.skip == 'false' && steps.up_to_date.outputs.result == 'up_to_date'
        run: |
          set -euo pipefail
          echo "PR_TITLE=${{ steps.pr.outputs.title }}" >> $GITHUB_ENV
          echo "PR_AUTHOR=${{ steps.pr.outputs.author }}" >> $GITHUB_ENV
          echo "PR_BRANCH=${{ steps.pr.outputs.branch }}" >> $GITHUB_ENV
          echo "BASE_BRANCH=${{ steps.pr.outputs.base_branch }}" >> $GITHUB_ENV
          
          # Calculate SHAs for the changelog entry (Code comparison)
          echo "PREV_SHA=$(git rev-parse origin/${{ steps.pr.outputs.base_branch }})" >> $GITHUB_ENV
          echo "NEW_SHA=$(git rev-parse origin/${{ steps.pr.outputs.branch }})" >> $GITHUB_ENV

      - name: Update CHANGELOG.md on Feature Branch
        if: steps.permission_check.outputs.allowed == 'true' && steps.check_changelog.outputs.skip == 'false' && steps.up_to_date.outputs.result == 'up_to_date'
        id: changelog
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          # Checkout feature branch to get current CHANGELOG content
          git checkout ${{ steps.pr.outputs.branch }}

          declare -A TYPE_MAP=(
            ["build"]="Build"
            ["ci"]="CI"
            ["docs"]="Documentation"
            ["feat"]="Feature"
            ["fix"]="Fix"
            ["perf"]="Performance"
            ["refactor"]="Refactor"
            ["style"]="Style"
            ["test"]="Test"
          )

          # Parse type, scope, and description from PR_TITLE
          TYPE=$(echo "$PR_TITLE" | sed -E 's/^([a-z]+)(\([^\)]*\))?:.*/\1/')
          SCOPE=$(echo "$PR_TITLE" | sed -nE 's/^[a-z]+\(([^)]*)\):.*/\1/p' || true)
          DESCRIPTION=$(echo "$PR_TITLE" | sed -E 's/^[a-z]+(\([^\)]*\))?:\s*(.*)/\2/')
          TYPE_HUMAN="${TYPE_MAP[$TYPE]}"

          if [[ -n "$TYPE_HUMAN" ]]; then
            if [[ -n "$SCOPE" ]]; then
              PREFIX="**${TYPE_HUMAN}**(${SCOPE})"
            else
              PREFIX="**${TYPE_HUMAN}**"
            fi
          else
            PREFIX="**Other**"
          fi

          SHORT_PREV=$(echo $PREV_SHA | cut -c1-7)
          SHORT_NEW=$(echo $NEW_SHA | cut -c1-7)
          COMPARE_URL="https://github.com/${{ github.repository }}/compare/$SHORT_PREV...$SHORT_NEW"

          ENTRY="- ${PREFIX}: ${DESCRIPTION} ([#${PR_NUMBER}](https://github.com/${{ github.repository }}/pull/${PR_NUMBER})) by [@${PR_AUTHOR}](https://github.com/${PR_AUTHOR}) - [\`${SHORT_PREV}...${SHORT_NEW}\`](${COMPARE_URL})"

          # Read current CHANGELOG.md if present
          if [ -f CHANGELOG.md ]; then
            CHANGELOG_CONTENT=$(cat CHANGELOG.md)
          else
            CHANGELOG_CONTENT=""
          fi

          # If no "Unreleased Features" section, prepend it with details block
          if ! grep -q '^## Unreleased Features' CHANGELOG.md 2>/dev/null || [ ! -f CHANGELOG.md ]; then
            NEW_CHANGELOG="## Unreleased Features

          <details>
          <summary>All commits</summary>

          $ENTRY

          </details>

          $CHANGELOG_CONTENT"
          else
            # Insert the new entry as the first item after the blank line following summary
            NEW_CHANGELOG=$(awk -v entry="$ENTRY" 'BEGIN{done=0; after_summary=0}
            {
              if(!done && /<summary>All commits<\/summary>/){
                print
                after_summary=1
                next
              }
              if(after_summary && !done && /^$/) {
                print
                print entry
                done=1
                next
              }
              print
            }' CHANGELOG.md)
          fi

          # Get current file SHA from the feature branch (if exists)
          FILE_SHA=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/contents/CHANGELOG.md?ref=${{ steps.pr.outputs.branch }}" \
            --jq '.sha' 2>/dev/null || echo "null")

          # Create commit via API on the feature branch
          ENCODED_CONTENT=$(echo "$NEW_CHANGELOG" | base64 -w 0)

          # If file doesn't exist (sha null/empty) then create without sha; else update with sha
          if [ -z "$FILE_SHA" ] || [ "$FILE_SHA" = "null" ]; then
            if gh api \
              --method PUT \
              -H "Accept: application/vnd.github+json" \
              "/repos/${{ github.repository }}/contents/CHANGELOG.md" \
              -f message="chore(docs): create changelog for #${PR_NUMBER}" \
              -f content="$ENCODED_CONTENT" \
              -f branch="${{ steps.pr.outputs.branch }}" > /dev/null 2>&1; then
              echo "success=true" >> $GITHUB_OUTPUT
            else
              echo "success=false" >> $GITHUB_OUTPUT
              echo "error=api_commit_failed" >> $GITHUB_OUTPUT
            fi
          else
            if gh api \
              --method PUT \
              -H "Accept: application/vnd.github+json" \
              "/repos/${{ github.repository }}/contents/CHANGELOG.md" \
              -f message="chore(docs): update changelog for #${PR_NUMBER}" \
              -f content="$ENCODED_CONTENT" \
              -f sha="$FILE_SHA" \
              -f branch="${{ steps.pr.outputs.branch }}" > /dev/null 2>&1; then
              echo "success=true" >> $GITHUB_OUTPUT
            else
              echo "success=false" >> $GITHUB_OUTPUT
              echo "error=api_commit_failed" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Comment changelog failure
        if: failure() || (steps.permission_check.outputs.allowed == 'true' && steps.check_changelog.outputs.skip == 'false' && steps.changelog.outputs.success == 'false' && steps.up_to_date.outputs.result == 'up_to_date')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          gh api \
            --method PATCH \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/issues/comments/${{ steps.loading_comment.outputs.comment_id }}" \
            -f body='‚ùå Changelog update failed.

          **Error**: Failed to push changelog commit to the feature branch.
          
          Process aborted. No merge performed.

          [View workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          _@${{ env.COMMENTER }}_'
          # Ensure the job stops after notifying changelog failure
          exit 1

      - name: Fast-forward merge into base
        if: steps.permission_check.outputs.allowed == 'true' && steps.up_to_date.outputs.result == 'up_to_date'
        id: merge
        run: |
          set -euo pipefail
          git checkout ${{ steps.pr.outputs.base_branch }}

          if git merge --ff-only origin/${{ steps.pr.outputs.branch }}; then
            if git push origin ${{ steps.pr.outputs.base_branch }}; then
              echo "success=true" >> $GITHUB_OUTPUT
            else
              echo "success=false" >> $GITHUB_OUTPUT
              echo "error_type=push_failed" >> $GITHUB_OUTPUT
            fi
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "error_type=merge_failed" >> $GITHUB_OUTPUT
          fi

      - name: Revert changelog commit on failure
        if: (failure() || (steps.permission_check.outputs.allowed == 'true' && steps.up_to_date.outputs.result == 'up_to_date' && steps.merge.outputs.success == 'false')) && steps.changelog.outputs.success == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          gh api \
            --method PATCH \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/git/refs/heads/${{ steps.pr.outputs.branch }}" \
            -f sha="${{ env.NEW_SHA }}" \
            -f force=true

      - name: Comment merge failure
        if: failure() || (steps.permission_check.outputs.allowed == 'true' && steps.up_to_date.outputs.result == 'up_to_date' && steps.merge.outputs.success == 'false')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REVERT_MSG=""
          if [ "${{ steps.changelog.outputs.success }}" == "true" ]; then
            REVERT_MSG="üîÑ The changelog commit has been reverted from the feature branch."
          fi

          gh api \
            --method PATCH \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/issues/comments/${{ steps.loading_comment.outputs.comment_id }}" \
            -f body="‚ùå Merge failed.

          ${{ steps.merge.outputs.error_type == 'push_failed' && '**Push rejected**: This is likely due to repository rules (e.g., no merge commits allowed).' || '**Merge failed**: Fast-forward merge failed locally.' }}

          $REVERT_MSG

          [View workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          _@${{ env.COMMENTER }}_'
          # Ensure the job stops after notifying merge failure
          exit 1

      - name: Comment success
        if: steps.permission_check.outputs.allowed == 'true' && steps.merge.outputs.success == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if [ "${{ steps.check_changelog.outputs.skip }}" == "true" ]; then
             MSG="‚ÑπÔ∏è Changelog update skipped."
          else
             MSG="‚úÖ Changelog updated on feature branch."
          fi
          
          gh api \
            --method PATCH \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/issues/comments/${{ steps.loading_comment.outputs.comment_id }}" \
            -f body='üéâ Successfully fast-forward merged `${{ steps.pr.outputs.branch }}` into `${{ steps.pr.outputs.base_branch }}`.
          - Compare: https://github.com/${{ github.repository }}/compare/${{ env.PREV_SHA }}...${{ env.NEW_SHA }}

          '"$MSG"'

          [View workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})'
