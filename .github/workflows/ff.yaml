name: Merge Bot

on:
  issue_comment:
    types: [created]

jobs:
  fast-forward-merge:
    if: github.event.issue.pull_request != null && contains(github.event.comment.body, '/merge')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # needed for merge checks
          token: ${{ secrets.PAT }}

      - name: Get PR details
        id: pr
        uses: octokit/request-action@v2.x
        with:
          route: GET /repos/${{ github.repository }}/pulls/${{ github.event.issue.number }}
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}

      - name: Extract branch names
        run: |
          echo "PR_BRANCH=$(jq -r .head.ref <<< '${{ steps.pr.outputs.data }}')" >> $GITHUB_ENV
          echo "BASE_BRANCH=$(jq -r .base.ref <<< '${{ steps.pr.outputs.data }}')" >> $GITHUB_ENV

      - name: Fetch all branches
        run: git fetch origin +refs/heads/*:refs/remotes/origin/*

      - name: Check if PR is up to date
        id: up_to_date
        run: |
          git checkout $PR_BRANCH
          git fetch origin $BASE_BRANCH
          if git merge-base --is-ancestor origin/$BASE_BRANCH $PR_BRANCH; then
            echo "result=up_to_date" >> $GITHUB_OUTPUT
          else
            echo "result=outdated" >> $GITHUB_OUTPUT
          fi

      - name: Comment if outdated
        if: steps.up_to_date.outputs.result == 'outdated'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          body: "‚ö†Ô∏è Cannot fast-forward merge because `${{ env.PR_BRANCH }}` is not up to date with `${{ env.BASE_BRANCH }}`. Please rebase first."

      - name: Fast-forward merge into base
        if: steps.up_to_date.outputs.result == 'up_to_date'
        run: |
          git checkout $BASE_BRANCH
          git merge --ff-only $PR_BRANCH
          git push origin $BASE_BRANCH

      - name: Comment success
        if: steps.up_to_date.outputs.result == 'up_to_date'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          body: "üéâ Merged `${{ env.PR_BRANCH }}` into `${{ env.BASE_BRANCH }}`."
